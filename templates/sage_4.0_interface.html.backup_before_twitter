<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGE - Premium Financial Intelligence</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f8f9fa;
            color: #202124;
        }
        .header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #E1E8ED;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 20px; color: #202124; }
        .feed {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }
        .email-item {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .sender {
            color: #1DA1F2;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
        }
        .timestamp {
            color: #657786;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .email-title {
            font-size: 18px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        .keywords, .actors, .themes {
            font-size: 14px;
            color: #657786;
            margin-bottom: 8px;
        }
        .summary {
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #1DA1F2;
            font-size: 15px;
            line-height: 1.6;
            color: #202124;
            white-space: pre-wrap;
        }
        .summary a {
            color: #1DA1F2 !important;
            text-decoration: none;
            cursor: pointer;
        }
        .summary a:hover { text-decoration: underline; }
        .ai-score {
            margin-top: 12px;
            font-size: 14px;
            color: #657786;
        }
        
        /* Gmail-style Detail Panel */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 60%;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .detail-panel.open {
            right: 0;
        }
        .detail-header {
            padding: 20px;
            border-bottom: 1px solid #E1E8ED;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .detail-close {
            font-size: 24px;
            cursor: pointer;
            color: #657786;
            border: none;
            background: none;
        }
        .detail-close:hover { color: #202124; }
        .detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .email-subject {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .email-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #E1E8ED;
        }
        .sender-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1DA1F2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .sender-details {
            flex: 1;
        }
        .sender-name {
            font-weight: 600;
            color: #202124;
        }
        .email-date {
            color: #657786;
            font-size: 13px;
            margin-left: 10px;
        }
        .email-iframe {
            width: 100%;
            min-height: 500px;
            border: none;
            background: white;
        }
        
        /* Overlay for panel */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }
        .overlay.open {
            display: block;
        }
    
        /* Show More Button */
        .show-more-btn {
            background: #1DA1F2;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin: 8px 0;
            transition: background 0.2s;
        }
        
        .show-more-btn:hover {
            background: #1a8cd8;
        }
        
        .card-details {
            display: none;
        }
        
        .card-details.visible {
            display: block;
        }


        /* View filter buttons */
        .view-filters {
            margin-top: 10px;
        }
        
        .view-btn {
            background: transparent;
            color: #657786;
            border: 1px solid #E1E8ED;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .view-btn:hover {
            background: #f0f0f0;
            border-color: #1DA1F2;
            color: #1DA1F2;
        }
        
        .view-btn.active {
            background: #1DA1F2;
            color: white;
            border-color: #1DA1F2;
        }


        /* Gmail-style list view */
        /* Option D Enhanced: 3 lines, wider, bold title 30% larger */
        .gmail-list-row {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .row-line-1 {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .row-line-2 {
            font-weight: bold;
            font-size: 18.2px;  /* 30% larger than 14px */
            color: #202124;
            margin-bottom: 6px;
            line-height: 1.3;
        }
        
        .row-line-3 {
            color: #657786;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .preview-keywords {
            color: #1DA1F2;
            font-weight: 500;
        }
        
        .preview-separator {
            margin: 0 10px;
            color: #E1E8ED;
        }
        
        .preview-bullets {
            color: #657786;
        }
        
        .preview-keywords {
            color: #1DA1F2;
            font-weight: 500;
        }
        
        .preview-separator {
            margin: 0 10px;
            color: #E1E8ED;
        }
        
        .preview-bullets {
            color: #657786;
        }
        
        .gmail-list-row:hover {
            background: #f5f5f5;
        }
        
        .gmail-row-main {
            flex: 1;
        }
        
        .gmail-row-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .gmail-sender {
            font-weight: 600;
            color: #202124;
            font-size: 14px;
        }
        
        .gmail-time {
            color: #657786;
            font-size: 13px;
        }
        
        .gmail-title {
            color: #202124;
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .gmail-preview {
            color: #657786;
            font-size: 13px;
        }
        

        .attention-btn {
            background: transparent;
            border: 1px solid #E1E8ED;
            color: #657786;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .attention-btn:hover {
            background: #ffa500;
            color: white;
            border-color: #ffa500;
        }

        .junk-btn {
            background: transparent;
            border: 1px solid #E1E8ED;
            color: #657786;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 15px;
        }
        
        .junk-btn:hover {
            background: #ff4444;
            color: white;
            border-color: #ff4444;
        }

    
        /* Attention styling - orange left border + bold */
        .gmail-list-item.attention {
            border-left: 4px solid #FF6B35 !important;
            background: #FFF5F0 !important;
        }
        
        .gmail-list-item.attention .gmail-item-title {
            font-weight: 900 !important;
            color: #D84315 !important;
        }
        
        .attention-badge {
            color: #FF6B35;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* Fade out animation for junk */
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-20px); }
        }

    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>üì∞ SAGE - Premium Financial Intelligence</h1>
            
            <div class="view-filters" style="display: flex; gap: 10px;">
                <button class="view-btn active" onclick="switchToHybrid()">üîÑ Hybrid</button>
                <button class="view-btn" onclick="switchToNewsFlow()">üì∞ News Flow</button>
                <button class="view-btn" onclick="switchToAnalysis()">üìä Analysis</button>
                <button class="view-btn" onclick="switchToJunk()">üóëÔ∏è Junk</button>
            </div>
        </div>
    </div>
    
    <div class="feed" id="feed"></div>
    
    <!-- Overlay -->
    <div id="overlay" class="overlay" onclick="closeEmailDetail()"></div>
    
    <!-- Gmail-style Detail Panel -->
    <div id="detailPanel" class="detail-panel">
        <div class="detail-header">
            <h2>Email</h2>
            <button class="detail-close" onclick="closeEmailDetail()">&times;</button>
        </div>
        <div class="detail-body" id="detailContent">
            Loading...
        </div>
    </div>

    <script>

        function toggleDetails(cardId) {
            const details = document.getElementById('details-' + cardId);
            const btn = document.getElementById('btn-' + cardId);
            
            if (details.classList.contains('visible')) {
                details.classList.remove('visible');
                btn.textContent = 'Show More ‚ñº';
            } else {
                details.classList.add('visible');
                btn.textContent = 'Show Less ‚ñ≤';
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function openEmailDetail(emailId) {
            const panel = document.getElementById('detailPanel');
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('detailContent');
            
            content.innerHTML = '<div style="padding: 20px;">Loading...</div>';
            panel.classList.add('open');
            overlay.classList.add('open');
            
            try {
                const response = await fetch('/api/email/' + emailId);
                const email = await response.json();
                
                if (email.error) {
                    content.innerHTML = '<div style="padding: 20px; color: red;">Error: ' + email.error + '</div>';
                    return;
                }
                
                // Check if NewsBreif story
                const isNewsbrief = email.sender_tag && email.sender_tag.includes('Newsbrief');
                
                if (isNewsbrief) {
                    // Show story-specific content only
                    let html = '<div style="padding: 20px;">';
                    html += '<h2>' + email.title + '</h2>';
                    html += '<div style="color: #657786; margin: 10px 0;">' + email.sender_tag + '</div>';
                    
                    if (email.actors) {
                        html += '<div style="background: #e8f4fd; padding: 10px; margin: 10px 0; border-radius: 6px;">';
                        html += '<strong>üîë Keywords:</strong><br>' + email.actors + '</div>';
                    }
                    
                    if (email.enriched_content) {
                        html += '<div style="margin: 15px 0; line-height: 1.8;">';
                        html += '<strong>üìù Story:</strong><br>';
                        html += email.enriched_content.replace(/‚Ä¢/g, '<br>‚Ä¢');
                        html += '</div>';
                    }
                    
                    if (email.link) {
                        html += '<div style="margin: 15px 0;"><a href="' + email.link + '" target="_blank" style="color: #1DA1F2;">üîó Read Article</a></div>';
                    }
                    
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    // Non-NewsBreif - show full HTML
                    content.innerHTML = '<iframe id="emailIframe" style="width: 100%; height: 700px;"></iframe>';
                    const iframe = document.getElementById('emailIframe');
                    if (iframe && email.content_html) {
                        iframe.contentWindow.document.open();
                        iframe.contentWindow.document.write(email.content_html);
                        iframe.contentWindow.document.close();
                    }
                }
            } catch (error) {
                content.innerHTML = '<div style="padding: 20px; color: red;">Error: ' + error.message + '</div>';
            }
        }
        function closeEmailDetail() {
            document.getElementById('detailPanel').classList.remove('open');
            document.getElementById('overlay').classList.remove('open');
        }

        // Close on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeEmailDetail();
        });




        function switchToHybrid() {
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reload with Twitter cards (current loadFeed)
            loadFeed();
        }
        
        function switchToNewsFlow() {
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Fetch data and render Gmail list
            fetch('/api/feed')
                .then(response => response.json())
                .then(data => {
                    if (data.items) {
                        renderGmailList(data.items);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Render Gmail-style list view
        function renderGmailList(items, isJunkView = false) {
            const feedDiv = document.getElementById('feed');
            // Don't clear if isJunkView (header was already set)
            if (!isJunkView) {
                feedDiv.innerHTML = '';
            }
            
            // For Junk view, show ALL items; for News Flow, show only NewsBreif
            const itemsToShow = isJunkView ? items : items.filter(item => 
                item.sender_tag && item.sender_tag.includes('Newsbrief')
            );
            
            itemsToShow.forEach(item => {
                const row = document.createElement('div');
                row.className = 'gmail-list-row';
                row.setAttribute('data-email-id', item.id);
                if (item.is_attention) row.classList.add('attention');
                
                // Main content div
                const mainDiv = document.createElement('div');
                mainDiv.className = 'gmail-row-main';
                
                // Line 1: Sender | Time
                const line1 = document.createElement('div');
                line1.className = 'row-line-1';
                line1.innerHTML = '<span class="gmail-sender">' + (item.sender_tag || 'Unknown') + '</span>' +
                                 '<span class="gmail-time">' + new Date(item.created_at).toLocaleString('en-US', {
                                     month: 'numeric', day: 'numeric', hour: 'numeric', minute: '2-digit'
                                 }).replace(', ', ' ') + '</span>';
                
                // Line 2: Title
                const line2 = document.createElement('div');
                line2.className = 'row-line-2';
                line2.textContent = item.title;
                
                // Line 3: Keywords | Bullets
                const line3 = document.createElement('div');
                line3.className = 'row-line-3';
                let bulletPreview = '';
                if (item.enriched_content) {
                    const bulletMatches = item.enriched_content.match(/‚Ä¢[^‚Ä¢]+/g);
                    if (bulletMatches && bulletMatches.length > 0) {
                        const first2 = bulletMatches.slice(0, 2).map(b => b.trim());
                        bulletPreview = first2.join(' ');
                        if (bulletMatches.length > 2) {
                            bulletPreview += ' (+' + (bulletMatches.length - 2) + ' more)';
                        }
                    }
                }
                line3.innerHTML = '<span class="preview-keywords">üîë ' + (item.actors || '') + '</span>' +
                                 '<span class="preview-separator">|</span>' +
                                 '<span class="preview-bullets">üìù ' + bulletPreview + '</span>';
                
                mainDiv.appendChild(line1);
                mainDiv.appendChild(line2);
                mainDiv.appendChild(line3);
                
                // Buttons div
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'row-buttons';
                
                if (isJunkView) {
                    const restoreBtn = document.createElement('button');
                    restoreBtn.className = 'attention-btn';
                    restoreBtn.textContent = '‚Ü©Ô∏è';
                    restoreBtn.onclick = function(e) {
                        e.stopPropagation();
                        unmarkJunk(item.id);
                    };
                    buttonsDiv.appendChild(restoreBtn);
                } else {
                    const attBtn = document.createElement('button');
                    attBtn.className = 'attention-btn';
                    attBtn.textContent = '‚ö†Ô∏è';
                    attBtn.onclick = function(e) {
                        e.stopPropagation();
                        toggleAttention(item.id);
                    };
                    
                    const junkBtn = document.createElement('button');
                    junkBtn.className = 'junk-btn';
                    junkBtn.textContent = 'üóëÔ∏è';
                    junkBtn.onclick = function(e) {
                        e.stopPropagation();
                        markAsJunk(item.id);
                    };
                    
                    buttonsDiv.appendChild(attBtn);
                    buttonsDiv.appendChild(junkBtn);
                }
                
                row.appendChild(mainDiv);
                row.appendChild(buttonsDiv);
                
                // Click to open detail
                row.onclick = function() {
                    openEmailDetail(item.id);
                };
                
                feedDiv.appendChild(row);
            });
        }
        
        function loadFeed() {
            fetch('/api/feed?t=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    const feedDiv = document.getElementById('feed');
                    feedDiv.innerHTML = '';
                    
                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            const emailDiv = document.createElement('div');
                            emailDiv.className = 'email-item';
                            
                            let html = '';
                            html += '<div class="sender">@' + (item.sender_tag || 'unknown') + '</div>';
                            html += '<div class="timestamp">¬∑ ' + formatTimestamp(item.created_at) + '</div>';
                            html += '<div class="email-title">' + (item.title || 'No title') + '</div>';
                            
                            emailDiv.innerHTML = html;
                            
                            // Add Show More button
                            const showMoreBtn = document.createElement('button');
                            showMoreBtn.className = 'show-more-btn';
                            showMoreBtn.id = 'btn-' + item.id;
                            showMoreBtn.textContent = 'Show More ‚ñº';
                            const cardId = item.id; // Capture in closure
                            showMoreBtn.onclick = function() { toggleDetails(cardId); };
                            emailDiv.appendChild(showMoreBtn);
                            

                            // Create collapsible details div and append it immediately
                            const detailsDiv = document.createElement('div');
                            detailsDiv.className = 'card-details';
                            detailsDiv.id = 'details-' + item.id;
                            
                            // **POPULATE THE DETAILS DIV WITH ENRICHED CONTENT**
                            let detailsHTML = '';
                            
                            // ALWAYS show keywords first (if available)
                            if (item.actors) {
                                detailsHTML += `<div style="margin-bottom: 10px; color: #657786;">
                                    <strong>üîë Keywords:</strong> ${item.actors}
                                </div>`;
                            }
                            
                            // Show enriched content (with HTML for proper bullet formatting)
                            if (item.enriched_content) {
                                // Convert plain bullets to HTML for vertical display
                                let content = item.enriched_content;
                                
                                // Replace text bullets with HTML list items
                                content = content.replace(/‚Ä¢ /g, '<br>‚Ä¢ ');
                                
                                detailsHTML += `<div style="margin-bottom: 10px; line-height: 1.8;">
                                    ${content}
                                </div>`;
                            }
                            
                            // ALWAYS show link (if available)
                            if (item.link) {
                                detailsHTML += `<div style="margin-top: 10px;">
                                    <a href="${item.link}" target="_blank" style="color: #1DA1F2; text-decoration: none;">
                                        üîó Read Full Article
                                    </a>
                                </div>`;
                            }
                            
                            // Show AI score
                            if (item.ai_score) {
                                detailsHTML += `<div style="margin-top: 10px; color: #657786;">
                                    ü§ñ AI: ${item.ai_score}/10
                                </div>`;
                            }
                            
                            // If nothing to show
                            if (!detailsHTML) {
                                detailsHTML = 'No enrichment available.';
                            }
                            
                            detailsDiv.innerHTML = detailsHTML;
                            emailDiv.appendChild(detailsDiv); // APPEND IT NOW!

                            
                            
                            // Add footer
                            const footerDiv = document.createElement('div');
                            footerDiv.className = 'ai-score';
                            footerDiv.textContent = 'ü§ñ AI: ' + (item.ai_score || item.ai_relevance_score || 0) + '/10';
                            detailsDiv.appendChild(footerDiv);  // Changed to detailsDiv
                            
                            feedDiv.appendChild(emailDiv);
                        });
                        
                        console.log('Loaded ' + data.items.length + ' items with HTML popup');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Load feed
        loadFeed();

        
        async function switchToAnalysis() {
            const feedDiv = document.getElementById('feed');
            feedDiv.innerHTML = '<div class="loading">Loading analysis...</div>';
            
            try {
                const response = await fetch('/api/feed?t=' + Date.now());
                const data = await response.json();
                const items = (data.items || []).filter(item => !item.sender_tag.includes('Newsbrief'));
                
                if (items.length === 0) {
                    feedDiv.innerHTML = '<div style="padding: 40px; text-align: center; color: #657786;">No analysis items.</div>';
                    return;
                }
                
                feedDiv.innerHTML = '';
                renderTwitterCards(items);
            } catch (error) {
                feedDiv.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
            }
        }

        async function switchToJunk() {
            const feedDiv = document.getElementById('feed');
            feedDiv.innerHTML = '<div class="loading">Loading junk...</div>';
            
            try {
                const response = await fetch('/api/feed?view=junk&t=' + Date.now());
                const data = await response.json();
                const items = data.items || [];
                
                if (items.length === 0) {
                    feedDiv.innerHTML = '<div style="padding: 40px; text-align: center; color: #657786;">üéâ No junk!</div>';
                    return;
                }
                
                // Clear and add header
                feedDiv.innerHTML = '<h3 style="padding: 20px; color: #657786; margin: 0;">üóëÔ∏è Junk (' + items.length + ')</h3>';
                // renderGmailList will append (not clear) when isJunkView=true
                renderGmailList(items, true);
            } catch (error) {
                feedDiv.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
            }
        }
        
        async function markAsJunk(emailId) {
            const response = await fetch('/api/mark_junk/' + emailId, { method: 'POST' });
            if (response.ok) {
                const el = document.querySelector('[data-email-id="' + emailId + '"]');
                if (el) {
                    el.classList.add('fade-out');
                    setTimeout(() => el.remove(), 300);
                }
            }
        }
        
        async function unmarkJunk(emailId) {
            const response = await fetch('/api/unmark_junk/' + emailId, { method: 'POST' });
            if (response.ok) {
                const el = document.querySelector('[data-email-id="' + emailId + '"]');
                if (el) {
                    el.classList.add('fade-out');
                    setTimeout(() => el.remove(), 300);
                }
            }
        }
        
        async function toggleAttention(emailId) {
            const response = await fetch('/api/toggle_attention/' + emailId, { method: 'POST' });
            if (response.ok) {
                const data = await response.json();
                const el = document.querySelector('[data-email-id="' + emailId + '"]');
                if (el) {
                    if (data.is_attention) {
                        el.classList.add('attention');
                    } else {
                        el.classList.remove('attention');
                    }
                }
            }
        }

    </script>
</body>
</html>
